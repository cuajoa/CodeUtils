

DECLARE @Fecha smalldatetime = '20220317'
SELECT FONDOS.NumFondo AS FondoNumero, FONDOS.NombreAbreviado,  TPVALORESCP.Abreviatura AS TipoVCPAbreviatura,     CUOTAPARTISTAS.NumCuotapartista AS CuotapartistaNumero, CUOTAPARTISTAS.Nombre AS CuotapartistaNombre,    SUM(LIQUIDACIONES.CantCuotapartes) AS CuotapartesTotales, SUM(LIQUIDACIONES.CantCuotapartes) * VALORESCP.ValorCuotaparte AS CuotapartesValuadas,    VALORESCP.ValorCuotaparte AS UltimoVCPValor, MAX(VALORESCP.Fecha) AS UltimoVCPFecha,  MONEDASLIQ.Simbolo as MonedaSimbolo,	COALESCE(PERSONAS.CUIL, PERSONAS.CUIT, CPTJURIDICOS.CUIT) AS 'CUIT/CUIL'FROM LIQUIDACIONES    INNER JOIN CUOTAPARTISTAS ON LIQUIDACIONES.CodCuotapartista = CUOTAPARTISTAS.CodCuotapartista    INNER JOIN CONDOMINIOS ON CONDOMINIOS.CodCuotapartista = CUOTAPARTISTAS.CodCuotapartista    INNER JOIN PERSONAS ON PERSONAS.CodPersona = CONDOMINIOS.CodPersona		AND PERSONAS.CodPersona IN (SELECT TOP 1 CodPersona FROM CONDOMINIOS WHERE CodCuotapartista = CUOTAPARTISTAS.CodCuotapartista AND EstaAnulado=0)	INNER JOIN CPTJURIDICOS ON CUOTAPARTISTAS.CodCuotapartista = CPTJURIDICOS.CodCuotapartista    INNER JOIN FONDOSREAL FONDOS ON FONDOS.CodFondo = LIQUIDACIONES.CodFondo    INNER JOIN MONEDAS MONEDASLIQ ON MONEDASLIQ.CodMoneda = LIQUIDACIONES.CodMoneda    INNER JOIN TPVALORESCP ON TPVALORESCP.CodFondo = LIQUIDACIONES.CodFondo And TPVALORESCP.CodTpValorCp = LIQUIDACIONES.CodTpValorCp    INNER JOIN VALORESCP ON VALORESCP.CodFondo = LIQUIDACIONES.CodFondo And VALORESCP.CodTpValorCp = LIQUIDACIONES.CodTpValorCp        AND VALORESCP.Fecha = (SELECT MAX(Fecha)        FROM VALORESCP VAL2MAX        WHERE VAL2MAX.CodFondo = VALORESCP.CodFondo            And VAL2MAX.CodTpValorCp = VALORESCP.CodTpValorCp And VAL2MAX.Fecha <= @Fecha)WHERE LIQUIDACIONES.EstaAnulado = 0 AND LIQUIDACIONES.FechaConcertacion <= @Fecha   AND FONDOS.EstaAnulado = 0 and CUOTAPARTISTAS.EstaAnulado = 0GROUP BY FONDOS.NombreAbreviado, FONDOS.NumFondo, TPVALORESCP.Abreviatura,         CUOTAPARTISTAS.NumCuotapartista, CUOTAPARTISTAS.Nombre,         VALORESCP.ValorCuotaparte, VALORESCP.Fecha,  MONEDASLIQ.Simbolo		,PERSONAS.CUIL, PERSONAS.CUIT, CPTJURIDICOS.CUITHAVING  SUM(LIQUIDACIONES.CantCuotapartes) > 0 ORDER BY FONDOS.NumFondo, TPVALORESCP.Abreviatura, CUOTAPARTISTAS.NumCuotapartista, VALORESCP.Fecha